<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Install HomeAssistant on docker &#43; Raspberry PI3</title>
	<meta name="description" content="">
	<meta name="generator" content="Hugo 0.46" />
	<meta property="og:title" content="Install HomeAssistant on docker &#43; Raspberry PI3" />
<meta property="og:description" content="Goal  Use the 3 nodes Raspeberry Cluster Access the WIFI, ZWave and Zigbee network Leverage the Nortek HUSBZB-1 Zwave and Zigbee dongle. Install Home Assistant on node 2 of the cluster  What OS  Home Assistant haas.io does not support Raspberry 3 B&#43; yet. haas.io is based on ResinOS. ResinOS is not using docker anymore but balena which does not support kubernetes yet See Issue Continue to use HyperiotOS  Install AppArmor and download docker container cat newpgklist apparmor-utils apt-transport-https avahi-daemon ca-certificates curl dbus jq network-manager socat software-properties-common  for i in `cat newpgklist` do sudo apt-get install -y $i done  Download and run the installation script." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2018-07-04-a/" />



<meta property="article:published_time" content="2018-07-04T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2018-07-04T00:00:00&#43;00:00"/>











	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<script type="text/javascript" src="/js/scripts.js"></script>
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body body-right-sidebar">
	<div class="container container-outer">
		<header class="header">
			<div class="container container-inner">
				<div class="logo" role="banner">
					<a class="logo__link" href="/" title="Jerome Brette&#39;s Blog" rel="home">
						<div class="logo__title">Jerome Brette&#39;s Blog</div>
						<div class="logo__tagline">Just another site</div>
					</a>
				</div>
			</div>
			<div class="divider"></div>
		</header>
		<div class="wrapper clearfix">

<main class="main content">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Install HomeAssistant on docker &#43; Raspberry PI3</h1><div class="post__meta meta">
<svg class="icon icon-time" width="16" height="14" viewBox="0 0 16 16"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
<time class="post__meta-date meta-date" datetime="2018-07-04T00:00:00">July 04, 2018</time>
<span class="post__meta-categories meta-categories">
	<svg class="icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta-categories__list"><a class="meta-categories__link" href="/categories/jekyll" rel="category">jekyll</a>, <a class="meta-categories__link" href="/categories/update" rel="category">update</a></span>
</span></div>
		</header><div class="post__content clearfix">
			

<h2 id="goal">Goal</h2>

<ul>
<li>Use the 3 nodes Raspeberry Cluster</li>
<li>Access the WIFI, ZWave and Zigbee network</li>
<li>Leverage the Nortek HUSBZB-1 Zwave and Zigbee dongle.</li>
<li>Install <a href="https://www.home-assistant.io/">Home Assistant</a> on node 2 of the cluster</li>
</ul>

<p><img src="/images/raspberrypi/IMG_0344.JPG" alt="" /></p>

<h2 id="what-os">What OS</h2>

<ul>
<li><a href="https://www.home-assistant.io/hassio/installation/">Home Assistant haas.io</a> does not support Raspberry 3 B+ yet.</li>
<li>haas.io is based on ResinOS. <a href="https://resinos.io/#downloads-raspberrypi">ResinOS</a> is not using docker anymore but balena which does not support kubernetes yet <a href="https://github.com/resin-os/balena/issues/84">See Issue</a></li>
<li>Continue to use HyperiotOS</li>
</ul>

<h2 id="install-apparmor-and-download-docker-container">Install AppArmor and download docker container</h2>

<pre><code>cat newpgklist

apparmor-utils
apt-transport-https
avahi-daemon
ca-certificates
curl
dbus
jq
network-manager
socat
software-properties-common
</code></pre>

<pre><code>for i in `cat newpgklist`
do
sudo apt-get install -y $i
done
</code></pre>

<p>Download and run the installation script. Will attempt to replace it by Kubernetes/Helm script.</p>

<pre><code>curl -sL https://raw.githubusercontent.com/home-assistant/hassio-build/master/install/hassio_install &gt; hassio_install
./hassio_install -m raspberrypi3
</code></pre>

<h2 id="installed-services">Installed Services</h2>

<h3 id="hassio-apparmor-service">hassio-apparmor service</h3>

<pre><code>cat /etc/systemd/system/hassio-apparmor.service

[Unit]
Description=Hass.io AppArmor
Wants=hassio-supervisor.service
Before=docker.service hassio-supervisor.service

[Service]
Type=oneshot
RemainAfterExit=true
ExecStart=/usr/sbin/hassio-apparmor

[Install]
WantedBy=multi-user.target
</code></pre>

<pre><code>cat /usr/sbin/hassio-apparmor

#!/bin/sh
set -e

# Load configs
CONFIG_FILE=/etc/hassio.json

# Read configs
DATA=&quot;$(jq --raw-output '.data // &quot;/usr/share/hassio&quot;' ${CONFIG_FILE})&quot;
PROFILES_DIR=${DATA}/apparmor
CACHE_DIR=&quot;${PROFILES_DIR}/cache&quot;
REMOVE_DIR=&quot;${PROFILES_DIR}/remove&quot;

# Exists AppArmor
if ! command -v apparmor_parser &gt; /dev/null 2&gt;&amp;1; then
    echo &quot;[Warning]: No apparmor_parser on host system!&quot;
    exit 0
fi

# Check folder structure
mkdir -p ${PROFILES_DIR}
mkdir -p ${CACHE_DIR}
mkdir -p ${REMOVE_DIR}

# Load/Update exists/new profiles
for profile in ${PROFILES_DIR}/*; do
    if [ ! -f ${profile} ]; then
        continue
    fi

    # Load Profile
    if ! apparmor_parser -r -W -L ${CACHE_DIR} ${profile}; then
        echo &quot;[Error]: Can't load profile ${profile}&quot;
    fi
done

# Cleanup old profiles
for profile in ${REMOVE_DIR}/*; do
    if [ ! -f ${profile} ]; then
        continue
    fi

    # Unload Profile
    if apparmor_parser -R -W -L ${CACHE_DIR} ${profile}; then
        if rm ${profile}; then
            continue
        fi
    fi
    echo &quot;[Error]: Can't remove profile ${profile}&quot;
done
</code></pre>

<h3 id="hassio-supervisor-service">hassio-supervisor service</h3>

<p>Main run seems to start hassio-supervisor</p>

<pre><code>cat /etc/systemd/system/hassio-supervisor.service

[Unit]
Description=Hass.io supervisor
Requires=docker.service
After=docker.service dbus.socket

[Service]
Type=simple
Restart=always
RestartSec=5s
ExecStartPre=-/usr/bin/docker stop hassio_supervisor
ExecStart=/usr/sbin/hassio-supervisor
ExecStop=-/usr/bin/docker stop hassio_supervisor

[Install]
WantedBy=multi-user.target
</code></pre>

<pre><code>cat /usr/sbin/hassio-supervisor

#!/bin/sh
set -e

# Load configs
CONFIG_FILE=/etc/hassio.json

SUPERVISOR=&quot;$(jq --raw-output '.supervisor' ${CONFIG_FILE})&quot;
HOMEASSISTANT=&quot;$(jq --raw-output '.homeassistant' ${CONFIG_FILE})&quot;
DATA=&quot;$(jq --raw-output '.data // &quot;/usr/share/hassio&quot;' ${CONFIG_FILE})&quot;

# AppArmor Support
if command -v apparmor_parser &gt; /dev/null 2&gt;&amp;1 &amp;&amp; grep hassio-supervisor /sys/kernel/security/apparmor/profiles &gt; /dev/null 2&gt;&amp;1; then
    APPARMOR=&quot;--security-opt apparmor=hassio-supervisor&quot;
else
    APPARMOR=&quot;--security-opt apparmor=unconfined&quot;
fi

# Init supervisor
HASSIO_DATA=${DATA}
HASSIO_IMAGE_ID=$(docker inspect --format='{{.Id}}' ${SUPERVISOR})
HASSIO_CONTAINER_ID=$(docker inspect --format='{{.Image}}' hassio_supervisor || echo &quot;&quot;)

runSupervisor() {
    docker rm --force hassio_supervisor || true
    docker run --name hassio_supervisor \
        $APPARMOR \
        --security-opt seccomp=unconfined \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v /var/run/dbus:/var/run/dbus \
        -v ${HASSIO_DATA}:/data \
        -e SUPERVISOR_SHARE=${HASSIO_DATA} \
        -e SUPERVISOR_NAME=hassio_supervisor \
        -e HOMEASSISTANT_REPOSITORY=${HOMEASSISTANT} \
        ${SUPERVISOR}
}

# Run supervisor
mkdir -p ${HASSIO_DATA}
([ &quot;${HASSIO_IMAGE_ID}&quot; = &quot;${HASSIO_CONTAINER_ID}&quot; ] &amp;&amp; docker start --attach hassio_supervisor) || runSupervisor
</code></pre>

<h2 id="docker-traces">Docker traces</h2>

<p>docker ps shows homeassistance images downloaded but no controlled yet by Kubernetes</p>

<pre><code>sudo docker ps

CONTAINER ID        IMAGE                                      COMMAND                  CREATED             STATUS              PORTS               NAMES
e1fd86ed3b20        homeassistant/raspberrypi3-homeassistant   &quot;/bin/entry.sh pytho…&quot;   28 minutes ago      Up 28 minutes                           homeassistant
f05058843583        homeassistant/armhf-hassio-supervisor      &quot;python3 -m hassio&quot;      30 minutes ago      Up 30 minutes                           hassio_supervisor

65d89478378b        d7ebe361fe95                               &quot;/usr/local/bin/kube…&quot;   30 minutes ago      Up 30 minutes                           k8s_kube-proxy_kube-proxy-4chwh_kube-system_68b68391-80b7-11e8-acaf-b827ebd5ad4c_2
9b8c7c2d431e        k8s.gcr.io/pause:3.1                       &quot;/pause&quot;                 30 minutes ago      Up 30 minutes                           k8s_POD_kube-proxy-4chwh_kube-system_68b68391-80b7-11e8-acaf-b827ebd5ad4c_2
8513e6cc5125        184e05022e7f                               &quot;/opt/bin/flanneld -…&quot;   About an hour ago   Up About an hour                        k8s_kube-flannel_kube-flannel-ds-wqxsz_kube-system_95f94b5f-80ba-11e8-acaf-b827ebd5ad4c_2
1aee6f79fe8e        k8s.gcr.io/pause:3.1                       &quot;/pause&quot;                 About an hour ago   Up About an hour                        k8s_POD_kube-flannel-ds-wqxsz_kube-system_95f94b5f-80ba-11e8-acaf-b827ebd5ad4c_1

</code></pre>

<pre><code># docker attach --sig-proxy=false f05058843583

18-07-06 06:50:19 INFO (MainThread) [hassio.addons] Load addons: 41 all - 41 new - 0 remove
18-07-06 06:50:19 INFO (MainThread) [hassio.updater] Fetch update data from https://s3.amazonaws.com/hassio-version/stable.json
18-07-06 06:50:19 INFO (MainThread) [hassio.snapshots] Found 0 snapshot files
18-07-06 06:50:19 INFO (MainThread) [__main__] Run HassIO
18-07-06 06:50:19 INFO (MainThread) [hassio.misc.dns] Start DNS port forwarding for host add-ons
18-07-06 06:50:19 INFO (MainThread) [hassio.core] Ignore Hass.io auto updates on dev channel
18-07-06 06:50:19 INFO (MainThread) [hassio.core] Start API on 172.30.32.2
18-07-06 06:50:19 INFO (MainThread) [hassio.addons] Startup initialize run 0 addons
18-07-06 06:50:19 INFO (MainThread) [hassio.addons] Startup system run 0 addons
18-07-06 06:50:19 INFO (MainThread) [hassio.addons] Startup services run 0 addons
18-07-06 06:50:21 INFO (SyncWorker_0) [hassio.docker.homeassistant] Start homeassistant homeassistant/raspberrypi3-homeassistant with version 0.73.0b6
18-07-06 06:51:01 INFO (MainThread) [hassio.homeassistant] Detect a running Home-Assistant instance
18-07-06 06:51:01 INFO (MainThread) [hassio.addons] Startup application run 0 addons
18-07-06 06:51:01 INFO (MainThread) [hassio.tasks] All core tasks are scheduled
18-07-06 06:51:01 INFO (MainThread) [hassio.core] Hass.io is up and running
</code></pre>

<h3 id="first-setup">First Setup</h3>

<p><img src="/images/homeassistant/HomeAssistant.png" alt="" /></p>

<h3 id="zigbee-zwave-support">Zigbee/ZWave support</h3>

<h3 id="enable-the-zigbee-zwave-dongle">Enable the zigbee/zwave dongle</h3>

<p>Locate the container</p>

<pre><code>sudo docker ps | grep homea

1fba92d1b40e        homeassistant/raspberrypi3-homeassistant   &quot;/bin/entry.sh pytho…&quot;   34 minutes ago      Up 34 minutes                           homeassistant
4c3f66563a3c        homeassistant/armhf-hassio-supervisor      &quot;python3 -m hassio&quot;      6 hours ago         Up 34 minutes                           hassio_supervisor
</code></pre>

<p>Enter the docker container</p>

<pre><code>sudo docker exec -ti 1fba92d1b40e /bin/bash
</code></pre>

<p>Edit the configuration file</p>

<pre><code>vi /config/configuration.yaml

zwave:
  usb_path: /dev/ttyUSB0

zha:
  usb_path: /dev/ttyUSB1
  database_path: /config/zigbee.db
</code></pre>

<p>Reload the configuration file
Access the UI and invoked reload core</p>

<pre><code>http://192.168.1.92:8123/config/core
</code></pre>

<pre><code>sudo docker ps | grep homea

702fd9424bfd        homeassistant/raspberrypi3-homeassistant   &quot;/bin/entry.sh pytho…&quot;   40 seconds ago      Up 38 seconds                           homeassistant
4c3f66563a3c        homeassistant/armhf-hassio-supervisor      &quot;python3 -m hassio&quot;      6 hours ago         Up 43 minutes                           hassio_supervisor
</code></pre>

<p>Let&rsquo;s get back in zigbee.db now exists</p>

<pre><code>sudo docker exec -ti 702fd9424bfd /bin/bash

bash-4.4# ls -lt
total 1928
-rw-r--r--    1 root     root       1802240 Jul  6 21:05 home-assistant_v2.db
-rw-r--r--    1 root     root         32768 Jul  6 21:05 home-assistant_v2.db-shm
-rw-r--r--    1 root     root            32 Jul  6 21:05 home-assistant_v2.db-wal
-rw-r--r--    1 root     root         14971 Jul  6 21:05 OZW_Log.txt
-rw-r--r--    1 root     root         45056 Jul  6 21:05 zigbee.db
-rw-r--r--    1 root     root           227 Jul  6 21:05 home-assistant.log
-rw-r--r--    1 root     root         32768 Jul  6 21:05 pyozw.sqlite
-rw-r--r--    1 root     root          1122 Jul  6 21:05 options.xml
-rw-r--r--    1 root     root          1866 Jul  6 21:01 configuration.yaml
drwxr-xr-x    2 root     root          4096 Jul  6 06:50 tts
-rw-r--r--    1 root     root             2 Jul  6 06:50 automations.yaml
-rw-r--r--    1 root     root             0 Jul  6 06:50 customize.yaml
-rw-r--r--    1 root     root             0 Jul  6 06:50 groups.yaml
-rw-r--r--    1 root     root             0 Jul  6 06:50 scripts.yaml
-rw-r--r--    1 root     root           157 Jul  6 06:50 secrets.yaml
drwxr-xr-x    2 root     root          4096 Jul  6 06:50 deps
</code></pre>

<h3 id="homeassistant-ui-screenshots">HomeAssistant UI Screenshots</h3>

<p><img src="/images/homeassistant/Overview1.png" alt="" />
<img src="/images/homeassistant/Overview2.png" alt="" /></p>

<h2 id="conclusion">Conclusion</h2>

<ul>
<li>Installation could not proceed further without solving the ZWave SUC Controller aspect.</li>
<li>Not willing to break my Lowe&rsquo;s IRIS based network yet and wanted to used Raspberry PI as a SUC Controller (see other post)</li>
<li>Also need to understand how to create persistency volume in Kubernetes in the PI Cluster (see other post)</li>
<li>Will be able to remove the dedicated the systemctl services since Kubernetes will control thoses.</li>
</ul>

<h2 id="links-and-repos">Links and Repos</h2>

<p>Discovery seems to need &ndash;network host if you want to discover the UPnP devices</p>

<ul>
<li><a href="https://www.home-assistant.io/components/discovery/">Link1</a></li>
<li><a href="https://github.com/jbrette/haas-helm">GitHUB associated repo</a></li>
</ul>

		</div>
		
	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Jerome Brette avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Jerome Brette</span>
	</div>
	<div class="authorbox__description">
		Jerome Brette&#39;s true identity is unknown. Maybe he is a successful blogger or writer. Nobody knows it.
	</div>
</div>
	
<nav class="post-nav row clearfix">
	<div class="post-nav__item post-nav__item--prev col-1-2">
		<a class="post-nav__link" href="/posts/2018-07-03-a/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">Creating a Raspberry 3 B&#43; Kubernetes Cluster</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next col-1-2">
		<a class="post-nav__link" href="/posts/2018-07-05-a/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">Install OpenHAB on docker &#43; Raspberry PI3</p></a>
	</div>
</nav>
	
</main>

<aside class="sidebar">
	
<div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="/" />
	</form>
</div>
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-28-a/">WIP: Deploy Cassandra on Raspberry-PI 3</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-19-a/">WIP: Build and Deploy MachineLearning Kubeflow Framework</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-18-a/">WIP: Compile and Test Portieris</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-17-a/">WIP: Rebuild Calico for AMD64 ad ARM32V7</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-16-a/">WIP: Rebuild Hyperkube images</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-15-a/">Recompile Kubernetes components for Raspberry PI</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-14-a/">Deploy Flannel in Raspberry PI cluster</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-13-a/">Deploy Helm and Tiller on Rasberry PI Cluster</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-12-a/">Enable docker remote API</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-11-a/">Use github repo as helm chart repository</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/hugo">Hugo</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/jekyll">Jekyll</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/update">Update</a></li>
		</ul>
	</div>
</div>
	
	
</aside>
	</div>
		<footer class="footer">
			<div class="container container-inner">
				<div class="footer__copyright">&copy; 2018 Jerome Brette&#39;s Blog. <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span></div>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script></body>
</html>