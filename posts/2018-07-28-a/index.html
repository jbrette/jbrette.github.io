<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>WIP: Deploy Cassandra on Raspberry-PI 3</title>
	<meta name="description" content="">
	<meta name="generator" content="Hugo 0.46" />
	<meta property="og:title" content="WIP: Deploy Cassandra on Raspberry-PI 3" />
<meta property="og:description" content="Goal  The main goal is to use statefulset and local persistency volume. The arm32v7 image are not available on kubernetes example repository The arm32v7 images are not available either on the docker hub, probably because Cassandra advises to use 64 bits when PI 3 are still mainly 32 bits OS and that the amount of memory available is limited to 1Gbi.  Build Cassandra for PI 3 Cassandra 1 Based on various Cassandra running on RPI projects" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2018-07-28-a/" />



<meta property="article:published_time" content="2018-07-28T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2018-07-28T00:00:00&#43;00:00"/>











	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<script type="text/javascript" src="/js/scripts.js"></script>
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body body-right-sidebar">
	<div class="container container-outer">
		<header class="header">
			<div class="container container-inner">
				<div class="logo" role="banner">
					<a class="logo__link" href="/" title="Jerome Brette&#39;s Blog" rel="home">
						<div class="logo__title">Jerome Brette&#39;s Blog</div>
						<div class="logo__tagline">Just another site</div>
					</a>
				</div>
			</div>
			<div class="divider"></div>
		</header>
		<div class="wrapper clearfix">

<main class="main content">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">WIP: Deploy Cassandra on Raspberry-PI 3</h1><div class="post__meta meta">
<svg class="icon icon-time" width="16" height="14" viewBox="0 0 16 16"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
<time class="post__meta-date meta-date" datetime="2018-07-28T00:00:00">July 28, 2018</time>
<span class="post__meta-categories meta-categories">
	<svg class="icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta-categories__list"><a class="meta-categories__link" href="/categories/jekyll" rel="category">jekyll</a>, <a class="meta-categories__link" href="/categories/update" rel="category">update</a></span>
</span></div>
		</header><div class="post__content clearfix">
			

<h2 id="goal">Goal</h2>

<ul>
<li>The main goal is to use statefulset and local persistency volume.</li>
<li>The arm32v7 image are not available on kubernetes example repository</li>
<li>The arm32v7 images are not available either on the docker hub, probably because Cassandra advises to use 64 bits when PI 3 are still mainly 32 bits OS and that the amount of memory available is limited to 1Gbi.</li>
</ul>

<h2 id="build-cassandra-for-pi-3">Build Cassandra for PI 3</h2>

<h3 id="cassandra-1">Cassandra 1</h3>

<p>Based on various Cassandra running on RPI projects</p>

<ul>
<li><a href="https://hub.docker.com/r/charlesyan/rpi-cassandra/">rpi-cassandra</a></li>
<li><a href="https://github.com/mcfongtw/docker-rpi-cassandra/">docker-rpi-cassandra</a></li>
<li><a href="https://github.com/jbrette/kube-rpi/tree/master/images/cassandra1">Docker image adapted to Kubernetes</a></li>
</ul>

<h3 id="cassandra-2">Cassandra 2</h3>

<p>This is a fork of Kubernetes example &ldquo;adapted&rdquo; to PI 3.</p>

<ul>
<li><a href="https://github.com/jbrette/examples/tree/master/cassandra">Official Kurnetes Example</a></li>
<li><a href="https://github.com/jbrette/kube-rpi/tree/master/images/cassandra2">Official Example adpated to PI</a></li>
</ul>

<h2 id="build-process">Build process</h2>

<p>Since travis cross build is not inplace, let&rsquo;s use a PI to build</p>

<pre><code class="language-bash">$ git clone git@github.com:jbrette/kube-rpi.git
$ cd kube-rpi/images/cassandra1
$ docker build .
$ docker image list
$ docker tag 6b98a0ccef38 jbrette/cassandra-arm32v7:3.11.1
$ docker push jbrette/cassandra-arm32v7:3.11.1
</code></pre>

<h2 id="deploy">Deploy</h2>

<p>The deployment of the services relies on the &ldquo;local-storage&rdquo; class</p>

<p>The service description is identical to Kubernetes tutorial</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  labels:
    app: cassandra
  name: cassandra
spec:
  clusterIP: None
  ports:
  - port: 9042
  selector:
    app: cassandra
</code></pre>

<p>The main difference with official examples:
- Memory reduces to 256M. 1Gi is too big for the PI.
- Use the &ldquo;local-storage&rdquo; class which is accessing local partition on the SD card of the PI.
- Change the image to previously build images.</p>

<pre><code class="language-yaml">apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: cassandra
  labels:
    app: cassandra
spec:
  serviceName: cassandra
  replicas: 3
  selector:
    matchLabels:
      app: cassandra
  template:
    metadata:
      labels:
        app: cassandra
    spec:
      terminationGracePeriodSeconds: 1800
      containers:
      - name: cassandra
        image: jbrette/cassandra-arm32v7:3.11.1
        imagePullPolicy: Always
        ports:
        - containerPort: 7000
          name: intra-node
        - containerPort: 7001
          name: tls-intra-node
        - containerPort: 7199
          name: jmx
        - containerPort: 9042
          name: cql
        resources:
          limits:
            cpu: &quot;500m&quot;
            memory: 256M
          requests:
           cpu: &quot;500m&quot;
           memory: 256M
        securityContext:
          capabilities:
            add:
              - IPC_LOCK
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/sh
              - -c
              - nodetool drain
        env:
          - name: MAX_HEAP_SIZE
            value: 128M
          - name: HEAP_NEWSIZE
            value: 50M
          - name: CASSANDRA_SEEDS
            value: &quot;cassandra-0.cassandra.default.svc.cluster.local&quot;
          - name: CASSANDRA_CLUSTER_NAME
            value: &quot;K8Demo&quot;
          - name: CASSANDRA_DC
            value: &quot;DC1-K8Demo&quot;
          - name: CASSANDRA_RACK
            value: &quot;Rack1-K8Demo&quot;
          - name: POD_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - /ready-probe.sh
          initialDelaySeconds: 15
          timeoutSeconds: 5
        # These volume mounts are persistent. They are like inline claims,
        # but not exactly because the names need to match exactly one of
        # the stateful pod volumes.
        volumeMounts:
        - name: cassandra-data
          mountPath: /cassandra_data
  # These are converted to volume claims by the controller
  # and mounted at the paths mentioned above.
  # do not use these in production until ssd GCEPersistentDisk or other ssd pd
  volumeClaimTemplates:
  - metadata:
      name: cassandra-data
    spec:
      accessModes: [ &quot;ReadWriteOnce&quot; ]
      storageClassName: local-storage
      resources:
        requests:
          storage: 1Gi

</code></pre>

<h2 id="testing">Testing</h2>

<p>Still work to be done on the image to get Cassandra operational</p>

<pre><code class="language-bash">$ kubectl get all

NAME                                             READY     STATUS             RESTARTS   AGE
pod/cassandra-0                                  1/1       Running            0          2h
pod/cassandra-1                                  0/1       CrashLoopBackOff   32         2h
pod/cassandra-2                                  1/1       Running            0          2h

NAME                                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE
service/cassandra                   ClusterIP   None          &lt;none&gt;        9042/TCP         5h

NAME                         DESIRED   CURRENT   AGE
statefulset.apps/cassandra   3         3         2h
</code></pre>

<p>Let&rsquo;s check the PVC</p>

<pre><code class="language-bash">$ kubectl get pvc

NAME                         STATUS    VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS    AGE
cassandra-data-cassandra-0   Bound     kube-node03-vol07   2Gi        RWO            local-storage   5h
cassandra-data-cassandra-1   Bound     kube-node01-vol04   2Gi        RWO            local-storage   2h
cassandra-data-cassandra-2   Bound     kube-node04-vol06   2Gi        RWO            local-storage   2h
</code></pre>

<p>Cassandra was able to create pvc using the local storage based pv</p>

<pre><code class="language-bash">$ kubectl describe pvc/cassandra-data-cassandra-0

Name:          cassandra-data-cassandra-0
Namespace:     default
StorageClass:  local-storage
Status:        Bound
Volume:        kube-node03-vol07
Labels:        app=cassandra
Annotations:   pv.kubernetes.io/bind-completed=yes
               pv.kubernetes.io/bound-by-controller=yes
Finalizers:    [kubernetes.io/pvc-protection]
Capacity:      2Gi
Access Modes:  RWO
Events:        &lt;none&gt;
</code></pre>

<p>Looks like a bug in the PV creation (using vol1 instead of vol7)</p>

<pre><code class="language-bash">$ kubectl describe pv/kube-node03-vol07

Name:              kube-node03-vol07
Labels:            &lt;none&gt;
Annotations:       pv.kubernetes.io/bound-by-controller=yes
Finalizers:        [kubernetes.io/pv-protection]
StorageClass:      local-storage
Status:            Bound
Claim:             default/cassandra-data-cassandra-0
Reclaim Policy:    Retain
Access Modes:      RWO
Capacity:          2Gi
Node Affinity:
  Required Terms:
    Term 0:        kubernetes.io/hostname in [kube-node03]
Message:
Source:
    Type:  LocalVolume (a persistent volume backed by local storage on a node)
    Path:  /mnt/disks/vol1
Events:    &lt;none&gt;
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<ul>
<li>WIP</li>
</ul>

<h2 id="reference-links">Reference Links</h2>

<ul>
<li>[Kubernetes cross build]()</li>
</ul>

		</div>
		
	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Jerome Brette avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Jerome Brette</span>
	</div>
	<div class="authorbox__description">
		Jerome Brette&#39;s true identity is unknown. Maybe he is a successful blogger or writer. Nobody knows it.
	</div>
</div>
	
<nav class="post-nav row clearfix">
	<div class="post-nav__item post-nav__item--prev col-1-2">
		<a class="post-nav__link" href="/posts/2018-07-19-a/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">WIP: Build and Deploy MachineLearning Kubeflow Framework</p></a>
	</div>
</nav>
	
</main>

<aside class="sidebar">
	
<div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="/" />
	</form>
</div>
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-28-a/">WIP: Deploy Cassandra on Raspberry-PI 3</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-19-a/">WIP: Build and Deploy MachineLearning Kubeflow Framework</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-18-a/">WIP: Compile and Test Portieris</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-17-a/">WIP: Rebuild Calico for AMD64 ad ARM32V7</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-16-a/">WIP: Rebuild Hyperkube images</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-15-a/">Recompile Kubernetes components for Raspberry PI</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-14-a/">Deploy Flannel in Raspberry PI cluster</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-13-a/">Deploy Helm and Tiller on Rasberry PI Cluster</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-12-a/">Enable docker remote API</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/2018-07-11-a/">Use github repo as helm chart repository</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/hugo">Hugo</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/jekyll">Jekyll</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/update">Update</a></li>
		</ul>
	</div>
</div>
	
	
</aside>
	</div>
		<footer class="footer">
			<div class="container container-inner">
				<div class="footer__copyright">&copy; 2018 Jerome Brette&#39;s Blog. <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span></div>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script></body>
</html>