---
layout: post
title:  "Deploy Flannel or Calico in Raspberry PI cluster"
date:   2018-07-14
categories: jekyll update
published: true
---

## Goal

- Flannel seems to deploy ok. Looks like in trouble when multiple interfaces available
- Calico in not compiled by default for Rapsberry PI

## Flannel

### Setup through kubectl

~~~
$ mkdir -p $HOME/kube-deployments/flannel
$ cd $HOME/kube-deployments/flannel
$ curl -sSL https://rawgit.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml | sed "s/amd64/arm/g" > flannel.yaml
$ kubectl create -f flannel.yaml 
~~~

### Solving issues

on master-pi, both the WLAN and LAN interfaces were activated. After unplugging the CAT5,
behavior was similar. Moreover this had some impact on the kube-apiserver (see the number of restarts).

~~~
$ kubectl get all --all-namespaces

NAMESPACE     NAME                                             READY     STATUS             RESTARTS   AGE
default       pod/helm-rpi-kubeplay-arm32v7-6cb66496c6-9w97m   1/1       Running            0          4h
kube-system   pod/coredns-78fcdf6894-cw5p8                     1/1       Running            15         10d
kube-system   pod/coredns-78fcdf6894-czjcj                     1/1       Running            15         10d
kube-system   pod/etcd-master-pi                               1/1       Running            11         10d
kube-system   pod/kube-apiserver-master-pi                     1/1       Running            599        10d
kube-system   pod/kube-controller-manager-master-pi            1/1       Running            38         10d
kube-system   pod/kube-flannel-ds-bhllh                        1/1       Running            13         9d
kube-system   pod/kube-flannel-ds-q7cp2                        0/1       CrashLoopBackOff   401        9d
kube-system   pod/kube-flannel-ds-wqxsz                        1/1       Running            16         9d
kube-system   pod/kube-proxy-4chwh                             1/1       Running            9          9d
kube-system   pod/kube-proxy-6r5mn                             1/1       Running            5          9d
kube-system   pod/kube-proxy-vvj6j                             1/1       Running            11         10d
kube-system   pod/kube-scheduler-master-pi                     1/1       Running            13         10d
kube-system   pod/kubernetes-dashboard-7d59788d44-rchkk        1/1       Running            20         7d
kube-system   pod/tiller-deploy-b59fcc885-66l7s                1/1       Running            0          6h
~~~

~~~
$ kubectl logs pod/kube-flannel-ds-q7cp2 -n kube-system

I0716 00:42:46.596796       1 main.go:474] Determining IP address of default interface
I0716 00:42:46.598043       1 main.go:487] Using interface with name wlan0 and address 192.168.1.95
I0716 00:42:46.598138       1 main.go:504] Defaulting external address to interface address (192.168.1.95)
I0716 00:42:46.775936       1 kube.go:283] Starting kube subnet manager
I0716 00:42:46.775907       1 kube.go:130] Waiting 10m0s for node controller to sync
I0716 00:42:47.776280       1 kube.go:137] Node controller sync successful
I0716 00:42:47.776400       1 main.go:234] Created subnet manager: Kubernetes Subnet Manager - master-pi
I0716 00:42:47.776431       1 main.go:237] Installing signal handlers
I0716 00:42:47.776697       1 main.go:352] Found network config - Backend type: vxlan
I0716 00:42:47.776900       1 vxlan.go:119] VXLAN config: VNI=1 Port=0 GBP=false DirectRouting=false
E0716 00:42:47.778884       1 main.go:279] Error registering network: failed to configure interface flannel.1: link has incompatible addresses. Remove additional addresses and try again. &{{%!s(int=5) %!s(int=1450) %!s(int=0) flannel.1 b6:3c:ad:4c:e3:68 up|broadcast|multicast %!s(uint32=69699) %!s(int=0) %!s(int=0) <nil>  %!s(*netlink.LinkStatistics=&{0 0 0 0 0 0 0 1991 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0}) %!s(int=0) %!s(*netlink.LinkXdp=&{0 false}) ether <nil> unknown} %!s(int=1) %!s(int=3) 192.168.1.95 <nil> %!s(int=0) %!s(int=0) %!s(bool=false) %!s(bool=false) %!s(bool=false) %!s(bool=false) %!s(bool=false) %!s(bool=true) %!s(bool=false) %!s(bool=false) %!s(int=300) %!s(int=0) %!s(int=8472) %!s(int=0) %!s(int=0)}
I0716 00:42:47.778991       1 main.go:332] Stopping shutdownHandler...
~~~

Deleting the pod, did not help. After recreation same issue reappeared.
~~~
$ kubectl delete pod/kube-flannel-ds-q7cp2 -n kube-system
~~~

~~~
$ kubectl get all --all-namespaces

NAMESPACE     NAME                                             READY     STATUS    RESTARTS   AGE
kube-system   pod/kube-flannel-ds-z7w4f                        0/1       Error     1          17s
~~~

Deleting the interface flannel.1 interface actually worked:
~~~
$ sudo ip link delete flannel.1
~~~

~~~
$ kubectl get all --all-namespaces

NAMESPACE     NAME                                             READY     STATUS    RESTARTS   AGE
kube-system   pod/kube-flannel-ds-z7w4f                        1/1       Running   5          3m
~~~

~~~
$ kubectl logs pod/kube-flannel-ds-z7w4f -n kube-system

I0716 00:52:14.555290       1 main.go:474] Determining IP address of default interface
I0716 00:52:14.564490       1 main.go:487] Using interface with name wlan0 and address 192.168.1.95
I0716 00:52:14.564578       1 main.go:504] Defaulting external address to interface address (192.168.1.95)
I0716 00:52:14.802491       1 kube.go:130] Waiting 10m0s for node controller to sync
I0716 00:52:14.802544       1 kube.go:283] Starting kube subnet manager
I0716 00:52:15.803114       1 kube.go:137] Node controller sync successful
I0716 00:52:15.803308       1 main.go:234] Created subnet manager: Kubernetes Subnet Manager - master-pi
I0716 00:52:15.803909       1 main.go:237] Installing signal handlers
I0716 00:52:15.804662       1 main.go:352] Found network config - Backend type: vxlan
I0716 00:52:15.804985       1 vxlan.go:119] VXLAN config: VNI=1 Port=0 GBP=false DirectRouting=false
I0716 00:52:15.875242       1 main.go:299] Wrote subnet file to /run/flannel/subnet.env
I0716 00:52:15.875367       1 main.go:303] Running backend.
I0716 00:52:15.875489       1 main.go:321] Waiting for all goroutines to exit
I0716 00:52:15.875559       1 vxlan_network.go:56] watching for new subnet leases
~~~

## Calico

### Compile Calico for Raspberry PI

- WIP

### Deploy on Raspberry PI

- WIP
 

## Results

- WIP

### Reference Links

- [Flannel Issue](https://github.com/coreos/flannel/issues/883)

