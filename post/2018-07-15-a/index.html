<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Recompile Kubernetes components for Raspberry PI</title>
	<meta name="description" content="">
	<meta name="generator" content="Hugo 0.46" />
	<meta property="og:title" content="Recompile Kubernetes components for Raspberry PI" />
<meta property="og:description" content="Goal  During the installation of official Kubernetes 1.11.0 on RPI Cluster 1, encountered a bug on the controller manager preventing the controller-manager from starting. (Strangely did not encounter the issue on RPI Cluster 2)&gt; The bug had been fixed by the Kubernetes kube-controller-manager - panic: runtime error: index out of range has been fixed and will be built as part of 1.11.1 The goal is to learn how to recompile Kubernetes from the source to be able to contribute when possible and address problems as soon as possible  Build Kubernetes executables for AMD64 and ARM Cross Compiling from Ubuntu Machine First check the go setup." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/2018-07-15-a/" />



<meta property="article:published_time" content="2018-07-15T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2018-07-15T00:00:00&#43;00:00"/>











	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<script type="text/javascript" src="/js/scripts.js"></script>
	<link rel="shortcut icon" href="/favicon.ico">
		
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-123357787-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body body-right-sidebar">
	<div class="container container-outer">
		<header class="header">
			<div class="container container-inner">
				<div class="logo" role="banner">
					<a class="logo__link" href="/" title="Jerome Brette&#39;s Blog" rel="home">
						<div class="logo__title">Jerome Brette&#39;s Blog</div>
						<div class="logo__tagline">Staying sharp by leveraging Raspberry PI as play and training grounds</div>
					</a>
				</div>
			</div>
			
<nav class="menu">
	<ul class="menu__list">
		<li class="menu__item"><a class="menu__link" href="/about/">ABOUT HUGO</a></li>
	</ul>
</nav>

		</header>
		<div class="wrapper clearfix">

<main class="main content">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Recompile Kubernetes components for Raspberry PI</h1><div class="post__meta meta">
<svg class="icon icon-time" width="16" height="14" viewBox="0 0 16 16"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
<time class="post__meta-date meta-date" datetime="2018-07-15T00:00:00">July 15, 2018</time>
<span class="post__meta-categories meta-categories">
	<svg class="icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta-categories__list"><a class="meta-categories__link" href="/categories/wiki" rel="category">wiki</a></span>
</span></div>
		</header>
		<figure class="post__thumbnail">
			<img src="/img/placeholder.jpg" alt="Recompile Kubernetes components for Raspberry PI">
		</figure>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#goal">Goal</a></li>
<li><a href="#build-kubernetes-executables-for-amd64-and-arm">Build Kubernetes executables for AMD64 and ARM</a>
<ul>
<li><a href="#cross-compiling-from-ubuntu-machine">Cross Compiling from Ubuntu Machine</a></li>
</ul></li>
<li><a href="#build-the-docker-image">Build the docker image</a></li>
<li><a href="#updating-kubeadm-and-kubernetes-configuration-to-use-the-patched-images">Updating Kubeadm and Kubernetes configuration to use the patched images</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#reference-links">Reference Links</a></li>
</ul></li>
</ul>
</nav>
	</div>
</div>
<div class="post__content clearfix">
			

<h2 id="goal">Goal</h2>

<ul>
<li>During the installation of official Kubernetes 1.11.0 on RPI Cluster 1,
encountered a bug on the controller manager preventing the controller-manager from starting.
(Strangely did not encounter the issue on RPI Cluster 2)&gt;</li>
<li>The bug had been fixed by the Kubernetes <a href="https://github.com/kubernetes/kubernetes/issues/65674">kube-controller-manager - panic: runtime error: index out of range</a>
has been fixed and will be built as part of 1.11.1</li>
<li>The goal is to learn how to recompile Kubernetes from the source to be able to contribute when possible and address problems as soon as possible</li>
</ul>

<h2 id="build-kubernetes-executables-for-amd64-and-arm">Build Kubernetes executables for AMD64 and ARM</h2>

<h3 id="cross-compiling-from-ubuntu-machine">Cross Compiling from Ubuntu Machine</h3>

<p>First check the go setup. Fetch the code</p>

<p>Let&rsquo;s check the go environment. See <a href="https://jbrette.github.io/jekyll/update/2018/06/22/a.html">Setup GOLANG environment</a></p>

<pre><code>$ which go

/usr/bin/go
</code></pre>

<pre><code>$ go version

go version go1.10.1 linux/amd64
</code></pre>

<p>Clone the code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ export GOPATH<span style="color:#f92672">=</span>$HOME/src
$ mkdir -p src/k8s.io
$ cd src/k8s.io
$ git clone -b release-1.11 git@github.com:kubernetes/kubernetes.git
$ cd kubernertes</code></pre></div>
<p>To save time, I removed platforms I had not use of and only kept amd64 and arm on linux</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat hack/lib/golang.sh</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">  <span style="color:#75715e"># The server platform we are building on.
</span><span style="color:#75715e"></span>  readonly KUBE_SERVER_PLATFORMS<span style="color:#f92672">=(</span>
    linux/amd64
    linux/arm
  <span style="color:#f92672">)</span>

  <span style="color:#75715e"># The node platforms we build for
</span><span style="color:#75715e"></span>  readonly KUBE_NODE_PLATFORMS<span style="color:#f92672">=(</span>
    linux/amd64
    linux/arm
  <span style="color:#f92672">)</span>

  <span style="color:#75715e"># If we update this we should also update the set of platforms whose standard library is precompiled for in build/build-image/cross/Dockerfile
</span><span style="color:#75715e"></span>  readonly KUBE_CLIENT_PLATFORMS<span style="color:#f92672">=(</span>
    linux/amd64
    linux/arm
  <span style="color:#f92672">)</span>

  <span style="color:#75715e"># Which platforms we should compile test targets for. Not all client platforms need these tests
</span><span style="color:#75715e"></span>  readonly KUBE_TEST_PLATFORMS<span style="color:#f92672">=(</span>
    linux/amd64
    linux/arm
  <span style="color:#f92672">)</span></code></pre></div>
<p>Double check your Docker setup is correct</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker run hello-world</code></pre></div>
<p>Clean the directory</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./build/make-clean.sh</code></pre></div>
<p>Rebuild the amd64 and arm executable</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./build/run.sh make cross</code></pre></div>
<p>Check the executables transfered from the docker build container to your vm by rsync</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd _output/dockerized/bin/linux</code></pre></div>
<p>Check the amd64 executables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls -lt amd64

total <span style="color:#ae81ff">2322696</span>
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">209961168</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:57 e2e_node.test
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">10645252</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:57 ginkgo
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">160051600</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:57 kubemark
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">231997872</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 genman
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">54099081</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 gendocs
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">54039865</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 genyaml
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">6694536</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 linkcheck
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">5481582</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 genswaggertypedocs
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">226061456</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 genkubedocs
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">173411368</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 e2e.test
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">55241186</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:52 kubectl
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">51912114</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:52 kube-proxy
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">57246829</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:51 kubeadm
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">162716256</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:51 kubelet
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">57908740</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 kube-aggregator
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">185152632</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 kube-apiserver
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">2330265</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 mounter
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">138048783</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 cloud-controller-manager
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">153798994</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 kube-controller-manager
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">227283184</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 hyperkube
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">59296776</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 apiextensions-apiserver
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">55471235</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 kube-scheduler
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">2835466</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:40 go-bindata
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">13630237</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:40 openapi-gen
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">7699847</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:40 conversion-gen
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">7669238</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:39 defaulter-gen
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">7695690</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:39 deepcopy-gen</code></pre></div>
<p>Check the RPI executables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -lt arm

total <span style="color:#ae81ff">2089216</span>
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">191189688</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:58 e2e_node.test
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">9286102</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:58 ginkgo
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">142111524</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:58 kubemark
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">210989712</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 genman
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">48169969</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 gendocs
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">48102745</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 genyaml
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">5847821</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 linkcheck
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">4927730</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 genswaggertypedocs
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">205458748</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 genkubedocs
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">155653412</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:55 e2e.test
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">49252169</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:52 kubectl
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">46156229</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:52 kube-proxy
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">50989514</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:52 kubeadm
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">144291264</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:52 kubelet
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">52024300</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 kube-aggregator
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">168751462</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 kube-apiserver
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">2231154</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 mounter
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">122701327</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 cloud-controller-manager
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">136828051</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 kube-controller-manager
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy <span style="color:#ae81ff">206769888</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 hyperkube
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">53220784</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 apiextensions-apiserver
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">49501810</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:50 kube-scheduler
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">2649635</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:40 go-bindata
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy  <span style="color:#ae81ff">11885551</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:40 openapi-gen
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">6770458</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:40 conversion-gen
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">6764729</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:39 defaulter-gen
-rwxr-xr-x <span style="color:#ae81ff">1</span> xxxxxx yyyyyy   <span style="color:#ae81ff">6770309</span> Jul <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">01</span>:39 deepcopy-gen</code></pre></div>
<p>Transfer the binaries to RPI machine</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp -r arm  rpiuser@192.168.1.94:/home/rpiuser/kubernetes_binaries</code></pre></div>
<h2 id="build-the-docker-image">Build the docker image</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir -p images/kube-controller-manager
$ cd images/kube-controller-manager
$ cp $HOME/kubernetes_binaries/kube-controller-manager</code></pre></div>
<p>Create a simple Dockerfile to update the executable</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat Dockerfile</code></pre></div>
<pre><code>FROM k8s.gcr.io/kube-controller-manager-arm:v1.11.0

COPY kube-controller-manager /usr/local/bin/kube-controller-manager
</code></pre>

<p>Build the image</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker build -t jbrette/kube-controller-manager-arm:v1.11.1</code></pre></div>
<p>Because of the brute force approach the image is twice as big since the executable (130MB) is
contained in two layers of the container image</p>

<pre><code>$ docker image list

REPOSITORY                               TAG                 IMAGE ID            CREATED             SIZE
jbrette/kube-controller-manager-arm      v1.11.1             b7023eef8fdf        8 hours ago         275MB
k8s.gcr.io/kube-apiserver-arm            v1.11.0             383bd2c4314e        2 weeks ago         170MB
k8s.gcr.io/kube-controller-manager-arm   v1.11.0             5b25f8a97aec        2 weeks ago         138MB
k8s.gcr.io/kube-scheduler-arm            v1.11.0             555ee860fa3c        2 weeks ago         50.5MB
k8s.gcr.io/kube-proxy-arm                v1.11.0             d7ebe361fe95        2 weeks ago         89.1MB
k8s.gcr.io/coredns                       1.1.3               7ceeb40862fb        7 weeks ago         31.3MB
k8s.gcr.io/etcd-arm                      3.2.18              ae02bf7047c8        3 months ago        221MB
quay.io/coreos/flannel                   v0.10.0-arm         c663d02f7966        5 months ago        39.9MB
k8s.gcr.io/pause-arm                     3.1                 e11a8cbeda86        6 months ago        374kB
k8s.gcr.io/pause                         3.1                 e11a8cbeda86        6 months ago        374kB
</code></pre>

<p>First push the controller-manager docker image to the repo</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker login

$ docker push jbrette/kube-controller-manager-arm:v1.11.1</code></pre></div>
<h2 id="updating-kubeadm-and-kubernetes-configuration-to-use-the-patched-images">Updating Kubeadm and Kubernetes configuration to use the patched images</h2>

<p>Because I only rebuild one image, I can not use the kubeadm feature which
allows to point to a different repo. Have to edit manually the configuration.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ more kube-controller-manager.yaml</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  annotations:
    scheduler.alpha.kubernetes.io/critical-pod: <span style="color:#e6db74">&#34;&#34;</span>
  creationTimestamp: <span style="color:#66d9ef">null</span>
  labels:
    component: kube-controller-manager
    tier: control-plane
  name: kube-controller-manager
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-controller-manager
    - --address=<span style="color:#ae81ff">127.0</span>.<span style="color:#ae81ff">0.1</span>
    - --allocate-node-cidrs=<span style="color:#66d9ef">true</span>
    - --cluster-cidr=<span style="color:#ae81ff">10.244</span>.<span style="color:#ae81ff">0.0</span>/<span style="color:#ae81ff">16</span>
    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
    - --controllers=<span style="color:#75715e">*,bootstrapsigner,tokencleaner</span>
    - --kubeconfig=/etc/kubernetes/controller-manager.conf
    - --leader-elect=<span style="color:#66d9ef">true</span>
    - --node-cidr-mask-size=<span style="color:#ae81ff">24</span>
    - --root-ca-file=/etc/kubernetes/pki/ca.crt
    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key
    - --use-service-account-credentials=<span style="color:#66d9ef">true</span>
    image: jbrette/kube-controller-manager-arm:v1.<span style="color:#ae81ff">11.1</span>
    imagePullPolicy: IfNotPresent
    livenessProbe:
      failureThreshold: <span style="color:#ae81ff">8</span>
      httpGet:
        host: <span style="color:#ae81ff">127.0</span>.<span style="color:#ae81ff">0.1</span>
        path: /healthz
        port: <span style="color:#ae81ff">10252</span>
        scheme: HTTP
      initialDelaySeconds: <span style="color:#ae81ff">15</span>
      timeoutSeconds: <span style="color:#ae81ff">15</span>
    name: kube-controller-manager
    resources:
      requests:
        cpu: 200m
    volumeMounts:
    - mountPath: /etc/ssl/certs
      name: ca-certs
      readOnly: <span style="color:#66d9ef">true</span>
    - mountPath: /etc/kubernetes/controller-manager.conf
      name: kubeconfig
      readOnly: <span style="color:#66d9ef">true</span>
    - mountPath: /usr/libexec/kubernetes/kubelet-plugins/volume/exec
      name: flexvolume-dir
    - mountPath: /usr/share/ca-certificates
      name: usr-share-ca-certificates
      readOnly: <span style="color:#66d9ef">true</span>
    - mountPath: /usr/local/share/ca-certificates
      name: usr-local-share-ca-certificates
      readOnly: <span style="color:#66d9ef">true</span>
    - mountPath: /etc/ca-certificates
      name: etc-ca-certificates
      readOnly: <span style="color:#66d9ef">true</span>
    - mountPath: /etc/kubernetes/pki
      name: k8s-certs
      readOnly: <span style="color:#66d9ef">true</span>
  hostNetwork: <span style="color:#66d9ef">true</span>
  priorityClassName: system-cluster-critical
  volumes:
  - hostPath:
      path: /etc/kubernetes/pki
      type: DirectoryOrCreate
    name: k8s-certs
  - hostPath:
      path: /etc/ssl/certs
      type: DirectoryOrCreate
    name: ca-certs
  - hostPath:
      path: /etc/kubernetes/controller-manager.conf
      type: FileOrCreate
    name: kubeconfig
  - hostPath:
      path: /usr/libexec/kubernetes/kubelet-plugins/volume/exec
      type: DirectoryOrCreate
    name: flexvolume-dir
  - hostPath:
      path: /usr/share/ca-certificates
      type: DirectoryOrCreate
    name: usr-share-ca-certificates
  - hostPath:
      path: /usr/local/share/ca-certificates
      type: DirectoryOrCreate
    name: usr-local-share-ca-certificates
  - hostPath:
      path: /etc/ca-certificates
      type: DirectoryOrCreate
    name: etc-ca-certificates
status: {}</code></pre></div>
<h2 id="conclusion">Conclusion</h2>

<ul>
<li>Need to streamline the build process</li>
<li>Need to streamline the image patching processed</li>
</ul>

<h2 id="reference-links">Reference Links</h2>

<ul>
<li>[Kubernetes cross build]()</li>
</ul>

		</div>
		
<div class="post__tags tags clearfix">
	<svg class="icon icon-tag" width="16" height="16" viewBox="0 0 16 16"><path d="M16 9.5c0 .373-.24.74-.5 1l-5 5c-.275.26-.634.5-1 .5-.373 0-.74-.24-1-.5L1 8a2.853 2.853 0 0 1-.7-1C.113 6.55 0 5.973 0 5.6V1.4C0 1.034.134.669.401.401.67.134 1.034 0 1.4 0h4.2c.373 0 .95.113 1.4.3.45.187.732.432 1 .7l7.5 7.502c.26.274.5.632.5.998zM3.5 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/kubernetes/" rel="tag">kubernetes</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/rpi/" rel="tag">rpi</a></li>
	</ul>
</div>
	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Jerome Brette avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Jerome Brette</span>
	</div>
	<div class="authorbox__description">
		Jerome Brette is a Principal Architect at Ericsson particularly interested in edge network ecosystems, machine learning, big data.
	</div>
</div>
	
<nav class="post-nav row clearfix">
	<div class="post-nav__item post-nav__item--prev col-1-2">
		<a class="post-nav__link" href="/post/2018-07-14-a/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">Deploy Flannel in Raspberry PI cluster</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next col-1-2">
		<a class="post-nav__link" href="/post/2018-07-16-a/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">WIP: Rebuild Hyperkube images</p></a>
	</div>
</nav>
	
</main>

<aside class="sidebar">
	
<div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="/" />
	</form>
</div>
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/post/2018-07-28-a/">WIP: Deploy Cassandra on Raspberry-PI 3</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/2018-07-19-a/">WIP: Build and Deploy MachineLearning Kubeflow Framework</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/2018-07-18-a/">WIP: Compile and Test Portieris</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/2018-07-17-a/">WIP: Rebuild Calico for AMD64 ad ARM32V7</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/2018-07-16-a/">WIP: Rebuild Hyperkube images</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/news">News</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/wiki">Wiki</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="LinkedIn" rel="noopener noreferrer" href="https://linkedin.com/in/jerome-brette-109b8711" target="_blank">
				<svg class="widget-social__link-icon icon-linkedin" viewBox="0 0 352 352" width="24" height="24" fill="#fff"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/jbrette" target="_blank">
				<svg class="widget-social__link-icon icon-github" viewBox="0 0 384 374" width="24" height="24" fill="#fff"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
	</div>
</div>
	
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/ansible" title="Ansible">Ansible</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/bigdata" title="Bigdata">Bigdata</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/calico" title="Calico">Calico</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cni" title="Cni">Cni</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/coreos" title="Coreos">Coreos</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/docker" title="Docker">Docker</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/github" title="Github">Github</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/golang" title="Golang">Golang</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/helm" title="Helm">Helm</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/homeautomation" title="Homeautomation">Homeautomation</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/java" title="Java">Java</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/kubeadm" title="Kubeadm">Kubeadm</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/kubernetes" title="Kubernetes">Kubernetes</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/machinelearning" title="Machinelearning">Machinelearning</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/portieris" title="Portieris">Portieris</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/python" title="Python">Python</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/rpi" title="Rpi">Rpi</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/sonobuoy" title="Sonobuoy">Sonobuoy</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/zuul" title="Zuul">Zuul</a>
	</div>
</div>
</aside>
	</div>
		<footer class="footer">
			<div class="container container-inner">
				<div class="footer__copyright">&copy; 2018 Jerome Brette&#39;s Blog. <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span></div>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>